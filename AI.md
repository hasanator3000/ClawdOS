# AI Agent Setup Instructions

## Quick Start

**Run ONE of these from repo root:**

```bash
npm run deploy  # ← Recommended (works in any Node.js environment)
```

**OR**

```bash
./setup         # ← Direct bash script
```

**OR**

```bash
make install    # ← Using Makefile
```

That's it. The script outputs JSON with URL and credentials.

---

## Prerequisites

**Required:**
- Docker (running, with docker compose)
- Node.js ≥ 22
- Git, bash, curl, openssl, python3

**Optional:**
- systemd (for persistent service)
- `~/.clawdbot/clawdbot.json` (for AI chat integration)

---

## What the script does

1. Auto-detects your Clawdbot gateway token from `~/.clawdbot/clawdbot.json`
2. Auto-detects your Telegram bot token from the same file
3. Finds free ports for web server (default: 3000+) and PostgreSQL (default: 5432+)
4. Creates unique PostgreSQL container (name: `clawdos-<hash>-db`)
5. Installs npm dependencies
6. Applies database schema (`db/schema.sql`)
7. Creates admin user with auto-generated password
8. Builds the application (`npm run build`)
9. Starts the server (systemd service or background process)
10. Verifies Clawdbot connectivity (if token found)
11. Outputs JSON with deployment info

---

## Expected output (JSON)

```json
{
  "ok": true,
  "url": "http://localhost:3000",
  "username": "admin",
  "password": "<auto-generated>",
  "db_port": 5432,
  "web_port": 3000,
  "container": "clawdos-a1b2c3d4-db",
  "directory": "/path/to/ClawdOS",
  "clawdbot_token": "b15dbc59...",
  "consult_token": "cad62396...",
  "service": "clawdos-a1b2c3d4",
  "pid": 12345
}
```

**Report to the user:**
- URL: `http://localhost:3000`
- Username: `admin`
- Password: `<auto-generated>`

---

## What is `~/.clawdbot/clawdbot.json`?

This file contains Clawdbot configuration. The setup script reads these keys:

```json
{
  "gateway": {
    "port": 18789,
    "auth": {
      "token": "your-clawdbot-gateway-token-here"
    }
  },
  "channels": {
    "telegram": {
      "botToken": "1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
    }
  }
}
```

**If this file doesn't exist:**
- Script generates a random CLAWDBOT_TOKEN → AI chat **will NOT work**
- Telegram 2FA will be disabled
- Everything else works normally

---

## Scenarios

| Scenario | What happens |
|----------|--------------|
| With `~/.clawdbot/clawdbot.json` | ✅ Full setup: AI chat + Telegram 2FA work |
| Without Clawdbot config | ⚠️ Partial: Web works, AI chat doesn't (random token) |
| With Telegram token only | ✅ Web + Telegram 2FA work, AI chat random |
| No tokens at all | ⚠️ Basic: Web works, no AI, no Telegram |

---

## Ports

Default ports (auto-detected if busy):
- **Web server**: 3000, 3001, 3002, ...
- **PostgreSQL**: 5432, 5433, 5434, ...

**Healthcheck:**
```bash
curl -sS http://localhost:3000/login  # Should return HTML (200)
```

---

## Troubleshooting

| Error | Fix |
|-------|-----|
| `Docker is not running` | Start Docker daemon: `systemctl start docker` |
| `Node.js >= 22 required` | Install Node 22+: `nvm install 22` or use system package |
| `Port conflict` | Script auto-detects free ports, but check with `ss -tlnp` |
| `Database did not become ready` | Check Docker logs: `docker compose logs db` |
| `No Clawdbot config found` | Create `~/.clawdbot/clawdbot.json` or pass `--clawdbot-token` manually |
| `Upstream error 401` in chat | Wrong Clawdbot token, check `~/.clawdbot/clawdbot.json` |

---

## Update existing installation

```bash
cd /path/to/ClawdOS
git pull
npm install
npm run build
sudo systemctl restart clawdos-<instance-id>
```

---

## Remove installation

```bash
# Stop and disable systemd service
sudo systemctl stop clawdos-<instance-id>
sudo systemctl disable clawdos-<instance-id>
sudo rm /etc/systemd/system/clawdos-<instance-id>.service
sudo systemctl daemon-reload

# Stop and remove Docker containers
cd /path/to/ClawdOS
docker compose down -v

# Remove directory
cd ..
rm -rf ClawdOS
```

---

## Manual deployment (if `./setup` fails)

Read [DEPLOY.md](DEPLOY.md) for detailed manual instructions and all available options.

---

## Questions?

- **Full documentation**: See [INSTALL.md](INSTALL.md)
- **Architecture guide**: See `RULES/` directory
- **API integration**: See `RULES/06-CLAWDBOT-INTEGRATION.md`
